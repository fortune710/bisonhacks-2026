<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>benefind.ai | SNAP Eligibility + Food Support</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0c1222;
        --panel: #111a31;
        --text: #f2f5ff;
        --muted: #b9c2e6;
        --accent: #64a9ff;
        --success: #60d394;
        --error: #ff7b7b;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: Arial, Helvetica, sans-serif;
        background: radial-gradient(circle at top, #162745, var(--bg) 45%);
        color: var(--text);
        line-height: 1.5;
      }

      .skip-link {
        position: absolute;
        left: -9999px;
        top: 0.5rem;
        background: #fff;
        color: #000;
        padding: 0.5rem 0.75rem;
        border-radius: 0.4rem;
      }

      .skip-link:focus {
        left: 0.75rem;
        z-index: 1000;
      }

      header,
      main {
        max-width: 980px;
        margin: 0 auto;
        padding: 1rem;
      }

      header h1 {
        margin-bottom: 0.2rem;
        font-size: 2rem;
      }

      .tagline {
        margin-top: 0;
        color: var(--muted);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
      }

      section {
        background: color-mix(in srgb, var(--panel) 92%, black 8%);
        border: 1px solid color-mix(in srgb, var(--accent) 30%, transparent);
        border-radius: 0.8rem;
        padding: 1rem;
      }

      form {
        display: grid;
        gap: 0.7rem;
      }

      label {
        font-weight: bold;
      }

      input,
      button {
        font: inherit;
      }

      input {
        width: 100%;
        padding: 0.55rem;
        border-radius: 0.4rem;
        border: 1px solid #8ea6dc;
        background: #f7f9ff;
        color: #000;
      }

      button {
        width: fit-content;
        border: 0;
        border-radius: 0.4rem;
        background: var(--accent);
        color: #081325;
        padding: 0.55rem 0.8rem;
        font-weight: bold;
        cursor: pointer;
      }

      button:hover,
      button:focus-visible {
        filter: brightness(1.07);
      }

      .output {
        margin-top: 0.7rem;
        padding: 0.7rem;
        border-radius: 0.5rem;
        background: color-mix(in srgb, var(--panel) 84%, black 16%);
        border: 1px solid color-mix(in srgb, var(--accent) 20%, transparent);
      }

      .success {
        border-color: color-mix(in srgb, var(--success) 40%, transparent);
      }

      .error {
        border-color: color-mix(in srgb, var(--error) 45%, transparent);
      }

      .helper {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .chat-log {
        min-height: 180px;
        max-height: 320px;
        overflow: auto;
        margin-bottom: 0.7rem;
      }

      .msg {
        margin: 0.4rem 0;
        padding: 0.6rem;
        border-radius: 0.5rem;
      }

      .msg-user {
        background: color-mix(in srgb, var(--accent) 27%, transparent);
      }

      .msg-bot {
        background: color-mix(in srgb, var(--success) 24%, transparent);
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }
    </style>
  </head>
  <body>
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <header>
      <h1>benefind.ai</h1>
      <p class="tagline">
        SNAP eligibility estimates, nearby pantry lookup, local food-drive support, and voice-call-ready responses.
      </p>
    </header>

    <main id="main-content">
      <section aria-labelledby="intake-heading">
        <h2 id="intake-heading">Household intake</h2>
        <form id="intake-form" aria-describedby="intake-help">
          <div>
            <label for="zip-code">ZIP code</label>
            <input id="zip-code" name="zip_code" required pattern="[0-9]{5}" inputmode="numeric" />
          </div>
          <div>
            <label for="state">State (2-letter or full name)</label>
            <input id="state" name="state" required />
          </div>
          <div>
            <label for="income">Monthly household income (USD)</label>
            <input id="income" name="monthly_income" type="number" step="0.01" min="0" required />
          </div>
          <div>
            <label for="family-size">Family size</label>
            <input id="family-size" name="family_size" type="number" min="1" max="12" required />
          </div>
          <p id="intake-help" class="helper">
            Screen-reader friendly labels are provided for all fields. Use tab/shift+tab to navigate.
          </p>
        </form>
      </section>

      <div class="grid">
        <section aria-labelledby="eligibility-heading">
          <h2 id="eligibility-heading">Check SNAP eligibility</h2>
          <button id="eligibility-btn" type="button">Estimate eligibility</button>
          <div id="eligibility-output" class="output" role="status" aria-live="polite"></div>
        </section>

        <section aria-labelledby="resources-heading">
          <h2 id="resources-heading">Find food pantries and food drives</h2>
          <button id="resources-btn" type="button">Find nearby resources</button>
          <div id="resources-output" class="output" role="status" aria-live="polite"></div>
        </section>
      </div>

      <section aria-labelledby="chat-heading">
        <h2 id="chat-heading">Chat with benefind.ai</h2>
        <div
          id="chat-log"
          class="chat-log output"
          role="log"
          aria-live="polite"
          aria-relevant="additions text"
          tabindex="0"
        ></div>
        <form id="chat-form">
          <label for="chat-input">Ask a question</label>
          <input id="chat-input" required />
          <button type="submit">Send message</button>
        </form>
      </section>

      <section aria-labelledby="voice-heading">
        <h2 id="voice-heading">Voice summary for call workflows</h2>
        <p class="helper">
          Generate an ElevenLabs-ready MP3 summary that can be played in phone support flows.
        </p>
        <button id="voice-btn" type="button">Generate voice summary</button>
        <div id="voice-output" class="output" role="status" aria-live="polite"></div>
        <audio id="voice-audio" controls class="sr-only"></audio>
      </section>
    </main>

    <script>
      const intakeForm = document.getElementById("intake-form");
      const eligibilityOutput = document.getElementById("eligibility-output");
      const resourcesOutput = document.getElementById("resources-output");
      const chatLog = document.getElementById("chat-log");
      const voiceOutput = document.getElementById("voice-output");
      const voiceAudio = document.getElementById("voice-audio");

      const endpointHeaders = { "Content-Type": "application/json" };

      function profileFromForm() {
        const formData = new FormData(intakeForm);
        return {
          zip_code: String(formData.get("zip_code") || "").trim(),
          state: String(formData.get("state") || "").trim(),
          monthly_income: Number(formData.get("monthly_income")),
          family_size: Number(formData.get("family_size")),
        };
      }

      function renderOutput(node, html, isError = false) {
        node.classList.toggle("error", isError);
        node.classList.toggle("success", !isError);
        node.innerHTML = html;
      }

      async function postJson(url, body) {
        const response = await fetch(url, {
          method: "POST",
          headers: endpointHeaders,
          body: JSON.stringify(body),
        });
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.detail || "Request failed");
        }
        return payload;
      }

      function addChatMessage(text, who) {
        const messageEl = document.createElement("p");
        messageEl.className = `msg ${who === "user" ? "msg-user" : "msg-bot"}`;
        messageEl.textContent = text;
        chatLog.appendChild(messageEl);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      document.getElementById("eligibility-btn").addEventListener("click", async () => {
        const profile = profileFromForm();
        try {
          renderOutput(eligibilityOutput, "Checking eligibility...");
          const data = await postJson("/api/eligibility", profile);
          const snap = data.snap_estimate;
          renderOutput(
            eligibilityOutput,
            `<strong>Status:</strong> ${snap.likely_eligible ? "Likely eligible" : "Likely not eligible"}<br />
             <strong>Gross monthly limit:</strong> $${snap.gross_monthly_income_limit}<br />
             <strong>Estimated monthly benefit:</strong> $${snap.estimated_monthly_benefit}<br />
             <strong>Note:</strong> ${data.disclaimer}`
          );
        } catch (error) {
          renderOutput(eligibilityOutput, `<strong>Error:</strong> ${error.message}`, true);
        }
      });

      document.getElementById("resources-btn").addEventListener("click", async () => {
        const profile = profileFromForm();
        try {
          renderOutput(resourcesOutput, "Looking up nearby food resources...");
          const data = await postJson("/api/resources", {
            zip_code: profile.zip_code,
            state: profile.state,
          });

          const pantryList = (data.pantries || [])
            .map((p) => `<li><strong>${p.name}</strong>${p.address ? ` - ${p.address}` : ""}</li>`)
            .join("");
          const driveList = (data.food_drives || [])
            .map((d) => `<li><strong>${d.name}</strong>${d.date ? ` (${d.date})` : ""}</li>`)
            .join("");

          renderOutput(
            resourcesOutput,
            `<p><strong>Pantries:</strong></p><ul>${pantryList || "<li>None found</li>"}</ul>
             <p><strong>Food drives:</strong></p><ul>${driveList || "<li>None found</li>"}</ul>`
          );
        } catch (error) {
          renderOutput(resourcesOutput, `<strong>Error:</strong> ${error.message}`, true);
        }
      });

      document.getElementById("chat-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const chatInput = document.getElementById("chat-input");
        const text = chatInput.value.trim();
        if (!text) {
          return;
        }

        const profile = profileFromForm();
        addChatMessage(text, "user");
        chatInput.value = "";

        try {
          const data = await postJson("/api/chat", { message: text, ...profile });
          addChatMessage(data.reply, "bot");
        } catch (error) {
          addChatMessage(`Error: ${error.message}`, "bot");
        }
      });

      document.getElementById("voice-btn").addEventListener("click", async () => {
        const profile = profileFromForm();
        try {
          renderOutput(voiceOutput, "Generating call summary...");
          const data = await postJson("/api/voice/eligibility", { ...profile, include_audio: true });
          const voiceStatus = data.audio_status || "Voice summary generated.";
          renderOutput(
            voiceOutput,
            `<strong>Voice script:</strong> ${data.voice_script}<br /><strong>Status:</strong> ${voiceStatus}`
          );

          if (data.audio_base64) {
            voiceAudio.classList.remove("sr-only");
            voiceAudio.src = `data:audio/mpeg;base64,${data.audio_base64}`;
          } else {
            voiceAudio.classList.add("sr-only");
            voiceAudio.removeAttribute("src");
          }
        } catch (error) {
          renderOutput(voiceOutput, `<strong>Error:</strong> ${error.message}`, true);
        }
      });

      addChatMessage(
        "Hello, I am benefind.ai. I can estimate SNAP eligibility and find food support near you.",
        "bot"
      );
    </script>
  </body>
</html>
